-- ================================================================
-- RE:FACTOR EVENT TAB
-- Auto-integrates with main script when globals are available
-- ================================================================

-- Wait for main script to be ready
local function waitForMainScript()
    local maxWait = 30 -- Maximum 30 seconds
    local waited = 0
    
    while waited < maxWait do
        -- Check multiple possible global locations
        local Library = getgenv and getgenv().Library or _G.Library
        local Window = getgenv and getgenv().Window or _G.Window
        local Tabs = getgenv and getgenv().Tabs or _G.Tabs
        local MainScriptLoaded = getgenv and getgenv().MainScriptLoaded or _G.MainScriptLoaded
        
        if Library and Window and Tabs and MainScriptLoaded then
            print("‚úÖ Event Tab: Main script globals found!")
            return Library, Window, Tabs
        end
        
        task.wait(0.5)
        waited = waited + 0.5
    end
    
    error("‚ùå Event Tab: Main script not ready after " .. maxWait .. " seconds")
end

-- Get references to main script components
local Library, Window, Tabs = waitForMainScript()

-- ================================================================
-- SERVICES SETUP
-- ================================================================
local Services = {
    Workspace = game:GetService("Workspace"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    Players = game:GetService("Players"),
    CollectionService = game:GetService("CollectionService"),
    RunService = game:GetService("RunService")
}

local LocalPlayer = Services.Players.LocalPlayer

-- ================================================================
-- CREATE EVENT TAB
-- ================================================================
local EventTab = Window:AddTab("Event", "calendar")

-- ================================================================
-- AUTO HATCH SYSTEM
-- ================================================================
local AutoHatchGroupBox = EventTab:AddLeftGroupbox("AutoHatch ü•ö")

-- Variables for AutoHatch system
local AutoHatchEnabled = false
local BlacklistDinoEggs = false
local autoHatchConnection = nil

-- List of Dinosaur Egg names to blacklist
local DinosaurEggNames = {
    "Dinosaur Egg"
}

-- Function to check if an egg is a dinosaur egg
local function isDinosaurEgg(eggName)
    if not eggName then return false end
    
    for _, dinoEggName in pairs(DinosaurEggNames) do
        if eggName == dinoEggName then
            return true
        end
    end
    return false
end

-- Function to get all player's eggs
local function getPlayerEggs()
    local playerEggs = {}
    
    -- Get all eggs with PetEggServer tag that belong to the player
    for _, eggObject in pairs(Services.CollectionService:GetTagged("PetEggServer")) do
        if eggObject:GetAttribute("OWNER") == LocalPlayer.Name then
            table.insert(playerEggs, eggObject)
        end
    end
    
    return playerEggs
end

-- Function to check if an egg is ready to hatch
local function isEggReady(eggObject)
    -- Check if egg has READY attribute and it's true
    local ready = eggObject:GetAttribute("READY")
    local timeToHatch = eggObject:GetAttribute("TimeToHatch")
    
    -- Egg is ready if READY attribute is true OR TimeToHatch is 0 or nil
    return (ready == true) or (timeToHatch and timeToHatch <= 0)
end

-- Function to hatch an egg
local function hatchEgg(eggObject)
    -- Get the PetEggService remote event
    local PetEggService = Services.ReplicatedStorage.GameEvents:FindFirstChild("PetEggService")
    
    if PetEggService then
        -- Fire the server with "HatchPet" command and the egg object
        PetEggService:FireServer("HatchPet", eggObject)
        
        local eggName = eggObject:GetAttribute("EggName") or "Unknown Egg"
        print("ü•ö Hatched:", eggName)
        Library:Notify("ü•ö Hatched: " .. eggName, 2)
        return true
    else
        print("‚ùå PetEggService not found!")
        return false
    end
end

-- Main auto hatch function
local function performAutoHatch()
    if not AutoHatchEnabled then return end
    
    local playerEggs = getPlayerEggs()
    local hatchedCount = 0
    
    for _, eggObject in pairs(playerEggs) do
        if isEggReady(eggObject) then
            local eggName = eggObject:GetAttribute("EggName")
            
            -- Check if we should skip dinosaur eggs
            if BlacklistDinoEggs and isDinosaurEgg(eggName) then
                print("‚ö†Ô∏è Skipping Dinosaur Egg (blacklisted):", eggName)
                continue
            end
            
            -- Attempt to hatch the egg
            local success = hatchEgg(eggObject)
            if success then
                hatchedCount = hatchedCount + 1
                task.wait(0.5) -- Small delay between hatches
            end
        end
    end
    
    if hatchedCount > 0 then
        print("ü•ö Auto hatched", hatchedCount, "eggs")
    end
end

-- Auto Hatch toggle
AutoHatchGroupBox:AddToggle("AutoHatch", {
    Text = "Auto Hatch",
    Tooltip = "Automatically hatch ready eggs on your farm",
    Default = false,
    Callback = function(Value)
        AutoHatchEnabled = Value
        print("[cb] Auto Hatch toggled:", Value)
        
        if Value then
            Library:Notify("ü•ö Auto Hatch enabled!", 3)
            
            -- Start auto hatch loop
            autoHatchConnection = Services.RunService.Heartbeat:Connect(function()
                performAutoHatch()
            end)
        else
            Library:Notify("ü•ö Auto Hatch disabled!", 3)
            
            -- Stop auto hatch loop
            if autoHatchConnection then
                autoHatchConnection:Disconnect()
                autoHatchConnection = nil
            end
        end
    end,
})

-- Blacklist Dino Eggs toggle
AutoHatchGroupBox:AddToggle("BlacklistDinoEggs", {
    Text = "Blacklist Dino Eggs from Auto Hatch",
    Tooltip = "Skip dinosaur eggs when auto hatching",
    Default = false,
    Callback = function(Value)
        BlacklistDinoEggs = Value
        print("[cb] Blacklist Dino Eggs toggled:", Value)
        
        if Value then
            Library:Notify("ü¶ï Dinosaur eggs will be skipped during auto hatch", 3)
        else
            Library:Notify("ü•ö All eggs will be auto hatched (including dinosaur eggs)", 3)
        end
    end,
})

-- ================================================================
-- DINO MACHINE SYSTEM
-- ================================================================
local DinoMachineGroupBox = EventTab:AddRightGroupbox("Dino Machine ü¶ï")

-- Variables for Dino Machine system
local AutoClaimEnabled = false
local AutoGiveEnabled = false
local autoClaimConnection = nil
local autoGiveConnection = nil

-- Function to get dino machine data
local function getDinoMachineData()
    local success, result = pcall(function()
        local DataService = require(Services.ReplicatedStorage.Modules.DataService)
        local data = DataService:GetData()
        
        if not data then
            return nil
        end
        
        if not data.DinoMachine then
            return nil
        end
        
        return data.DinoMachine
    end)
    
    if success then
        return result
    else
        print("‚ùå Failed to get dino machine data:", result)
        return nil
    end
end

-- Function to check if machine reward is ready
local function isMachineRewardReady()
    local machineData = getDinoMachineData()
    if not machineData then
        return false
    end
    
    -- Machine is ready if RewardReady is true and TimeLeft is 0 or less
    return machineData.RewardReady == true and (machineData.TimeLeft or 0) <= 0
end

-- Function to claim machine reward
local function claimMachineReward()
    local success, err = pcall(function()
        local DinoMachineService_RE = Services.ReplicatedStorage.GameEvents:FindFirstChild("DinoMachineService_RE")
        
        if DinoMachineService_RE then
            DinoMachineService_RE:FireServer("ClaimReward")
            print("üéÅ Claimed dino machine reward!")
            Library:Notify("üéÅ Claimed dino machine reward!", 2)
            return true
        else
            print("‚ùå DinoMachineService_RE not found!")
            return false
        end
    end)
    
    if not success then
        print("‚ùå Failed to claim dino machine reward:", err)
        return false
    end
    
    return success
end

-- Main auto claim function
local function performAutoClaim()
    if not AutoClaimEnabled then return end
    
    if isMachineRewardReady() then
        claimMachineReward()
    end
end

-- Common Egg pets list (extracted from PetEggs.module.lua)
local CommonEggPets = {
    "Dog",
    "Golden Lab", 
    "Bunny"
}

-- Rare Egg pets list (extracted from PetEggs.module.lua)
local RareEggPets = {
    "Orange Tabby",
    "Monkey",
    "Spotted Deer", 
    "Rooster",
    "Pig"
}

-- Variables for Auto Give system
local SelectedCommonPets = {"Dog"} -- Default Common pets selection (multi-select)
local SelectedRarePets = {"Orange Tabby"} -- Default Rare pets selection (multi-select)
local autoGiveConnection = nil
local UseCommonEggs = true -- Default enabled
local UseRareEggs = false -- Default disabled

-- Function to get the currently selected pets based on enabled filters
local function getCurrentSelectedPets()
    local selectedPets = {}
    
    if UseCommonEggs and #SelectedCommonPets > 0 then
        for _, pet in pairs(SelectedCommonPets) do
            table.insert(selectedPets, pet)
        end
    end
    
    if UseRareEggs and #SelectedRarePets > 0 then
        for _, pet in pairs(SelectedRarePets) do
            table.insert(selectedPets, pet)
        end
    end
    
    return selectedPets
end

-- Add dropdown for Common Egg pet selection
DinoMachineGroupBox:AddDropdown("CommonPetSelection", {
    Values = CommonEggPets,
    Default = {1},
    Multi = true,
    Text = "Select Common Egg Pets",
    Tooltip = "Choose which Common Egg pets to automatically give to dino machine (multi-select)",
    Callback = function(Value)
        SelectedCommonPets = {}
        for _, v in pairs(Value) do
            table.insert(SelectedCommonPets, CommonEggPets[v])
        end
        print("[cb] Selected Common pets to give:", table.concat(SelectedCommonPets, ", "))
    end,
})

-- Add dropdown for Rare Egg pet selection
DinoMachineGroupBox:AddDropdown("RarePetSelection", {
    Values = RareEggPets,
    Default = {1},
    Multi = true,
    Text = "Select Rare Egg Pets",
    Tooltip = "Choose which Rare Egg pets to automatically give to dino machine (multi-select)",
    Callback = function(Value)
        SelectedRarePets = {}
        for _, v in pairs(Value) do
            table.insert(SelectedRarePets, RareEggPets[v])
        end
        print("[cb] Selected Rare pets to give:", table.concat(SelectedRarePets, ", "))
    end,
})

DinoMachineGroupBox:AddDivider()

-- Add toggles for egg type filters
DinoMachineGroupBox:AddToggle("UseCommonEggs", {
    Text = "Use Common Egg Pets",
    Tooltip = "Enable auto giving of selected Common Egg pet",
    Default = true,
    Callback = function(Value)
        UseCommonEggs = Value
        print("[cb] Use Common Eggs toggled:", Value)
        
        if Value then
            Library:Notify("‚úÖ Common Egg pets enabled: " .. table.concat(SelectedCommonPets, ", "), 2)
        else
            Library:Notify("‚ùå Common Egg pets disabled", 2)
        end
    end,
})

DinoMachineGroupBox:AddToggle("UseRareEggs", {
    Text = "Use Rare Egg Pets", 
    Tooltip = "Enable auto giving of selected Rare Egg pet",
    Default = false,
    Callback = function(Value)
        UseRareEggs = Value
        print("[cb] Use Rare Eggs toggled:", Value)
        
        if Value then
            Library:Notify("‚úÖ Rare Egg pets enabled: " .. table.concat(SelectedRarePets, ", "), 2)
        else
            Library:Notify("‚ùå Rare Egg pets disabled", 2)
        end
    end,
})

-- Function to check if dino machine is empty (ready to accept pets)
local function isMachineEmpty()
    local machineData = getDinoMachineData()
    if not machineData then
        return false
    end
    
    -- Machine is empty if it's not running and reward is not ready
    return not machineData.IsRunning and not machineData.RewardReady
end

-- Function to find player's pets by type
local function findPlayerPetsByType(petType)
    local foundPets = {}
    
    local success, result = pcall(function()
        -- Method 1: Use ActivePetsService to get pet inventory
        local ActivePetsService = require(Services.ReplicatedStorage.Modules.PetServices.ActivePetsService)
        local DataService = require(Services.ReplicatedStorage.Modules.DataService)
        
        local data = DataService:GetData()
        if not data or not data.PetsData or not data.PetsData.PetInventory then
            return {}
        end
        
        local petInventory = data.PetsData.PetInventory.Data
        for petUUID, petData in pairs(petInventory) do
            if petData.PetType == petType then
                table.insert(foundPets, {
                    uuid = petUUID,
                    petType = petData.PetType,
                    petData = petData
                })
            end
        end
        
        return foundPets
    end)
    
    if success then
        return result
    else
        print("‚ùå Failed to get pets from inventory:", result)
        return {}
    end
end

-- Function to give pet to dino machine
local function givePetToMachine(petUUID)
    local success, err = pcall(function()
        local DinoMachineService_RE = Services.ReplicatedStorage.GameEvents:FindFirstChild("DinoMachineService_RE")
        
        if DinoMachineService_RE then
            DinoMachineService_RE:FireServer("MachineInteract", petUUID)
            print("ü¶ï Gave pet to dino machine:", petUUID)
            Library:Notify("ü¶ï Gave pet to dino machine!", 2)
            return true
        else
            print("‚ùå DinoMachineService_RE not found!")
            return false
        end
    end)
    
    if not success then
        print("‚ùå Failed to give pet to dino machine:", err)
        return false
    end
    
    return success
end

-- Main auto give function
local function performAutoGive()
    if not AutoGiveEnabled then return end
    
    -- Only give pets when machine is empty
    if not isMachineEmpty() then
        return
    end
    
    -- Determine which pet types to try giving based on enabled filters
    local petsToTry = {}
    
    -- Add all selected Common pets first
    if UseCommonEggs and #SelectedCommonPets > 0 then
        for _, petType in pairs(SelectedCommonPets) do
            table.insert(petsToTry, {
                petType = petType,
                eggType = "Common"
            })
        end
    end
    
    -- Then add all selected Rare pets
    if UseRareEggs and #SelectedRarePets > 0 then
        for _, petType in pairs(SelectedRarePets) do
            table.insert(petsToTry, {
                petType = petType,
                eggType = "Rare"
            })
        end
    end
    
    -- Try to give pets in order (Common first, then Rare)
    for _, petInfo in pairs(petsToTry) do
        local availablePets = findPlayerPetsByType(petInfo.petType)
        
        if #availablePets > 0 then
            -- Give the first available pet
            local petToGive = availablePets[1]
            local success = givePetToMachine(petToGive.uuid)
            
            if success then
                print("ü¶ï Successfully gave", petInfo.eggType, "pet:", petInfo.petType)
                task.wait(2) -- Add delay to prevent spam
                return -- Exit after successfully giving one pet
            end
        end
    end
end

DinoMachineGroupBox:AddDivider()

-- Auto Give toggle
DinoMachineGroupBox:AddToggle("AutoGive", {
    Text = "Auto Give",
    Tooltip = "Automatically give selected pets to dino machine when empty",
    Default = false,
    Callback = function(Value)
        AutoGiveEnabled = Value
        print("[cb] Auto Give toggled:", Value)
        
        if Value then
            -- Check if at least one egg type is enabled
            if not UseCommonEggs and not UseRareEggs then
                Library:Notify("‚ö†Ô∏è Please enable at least one egg type filter first!", 3)
                task.wait(0.1)
                if Toggles and Toggles.AutoGive then
                    Toggles.AutoGive:SetValue(false)
                end
                return
            end
            
            -- Check if valid pets are selected for enabled egg types
            local validSelection = false
            local enabledPets = {}
            
            if UseCommonEggs and #SelectedCommonPets > 0 then
                validSelection = true
                for _, pet in pairs(SelectedCommonPets) do
                    table.insert(enabledPets, pet .. " (Common)")
                end
            end
            
            if UseRareEggs and #SelectedRarePets > 0 then
                validSelection = true
                for _, pet in pairs(SelectedRarePets) do
                    table.insert(enabledPets, pet .. " (Rare)")
                end
            end
            
            if not validSelection then
                Library:Notify("‚ö†Ô∏è Please select pets for enabled egg types!", 3)
                task.wait(0.1)
                if Toggles and Toggles.AutoGive then
                    Toggles.AutoGive:SetValue(false)
                end
                return
            end
            
            local petsText = table.concat(enabledPets, ", ")
            Library:Notify("üîÑ Auto Give enabled for: " .. petsText, 3)
            
            -- Start auto give loop
            autoGiveConnection = Services.RunService.Heartbeat:Connect(function()
                performAutoGive()
            end)
        else
            Library:Notify("üîÑ Auto Give disabled!", 3)
            
            -- Stop auto give loop
            if autoGiveConnection then
                autoGiveConnection:Disconnect()
                autoGiveConnection = nil
            end
        end
    end,
})

-- Auto Claim toggle
DinoMachineGroupBox:AddToggle("AutoClaim", {
    Text = "Auto Claim",
    Tooltip = "Automatically claim rewards from dino machine when ready",
    Default = false,
    Callback = function(Value)
        AutoClaimEnabled = Value
        print("[cb] Auto Claim toggled:", Value)
        
        if Value then
            Library:Notify("üéÅ Auto Claim enabled!", 3)
            
            -- Start auto claim loop
            autoClaimConnection = Services.RunService.Heartbeat:Connect(function()
                performAutoClaim()
            end)
        else
            Library:Notify("üéÅ Auto Claim disabled!", 3)
            
            -- Stop auto claim loop
            if autoClaimConnection then
                autoClaimConnection:Disconnect()
                autoClaimConnection = nil
            end
        end
    end,
})

-- ================================================================
-- EVENT TAB INITIALIZATION COMPLETE
-- ================================================================
print("üéâ Event Tab with AutoHatch initialized successfully!")
Library:Notify("ü•ö AutoHatch Event Tab loaded!", 3)

-- Return success indicator
return true
